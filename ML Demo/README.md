# Azure ML Service Demo

This project demonstrates a data pipeline integrating Azure ML services to train on raw image data and return predictions.

## Architecture Overview

The system consists of the following components:

1. **Web App (HTML + JS)**: Uploads images to the Producer service
2. **Producer (Python)**: Sends images to Azure Event Hub for ingestion
3. **Azure Event Hub**: Streams images to storage & ML processing, and streams predictions to the Consumer
4. **Azure Blob Storage**: Stores images for batch training
5. **Azure Functions**:
   - Training Function (Timer Trigger): Runs periodically to fetch images and train the model
   - Prediction Function (Event Hub Trigger): Reacts to new images, sends them to the ML model, and forwards predictions
6. **Azure ML Services**: Handles model training and inference
7. **Consumer (Python)**: Retrieves predictions and displays results on the web app

## Configuration

The project uses a centralized configuration approach:

- `config.json`: Contains all Azure resource names, settings, and configuration parameters
- `local.settings.json`: Generated by the provisioning script, contains connection strings and other runtime settings
- `config_utils.py`: Provides a shared configuration management utility that automatically refreshes settings

### Dynamic Configuration

The system includes a `ConfigurationManager` class that:

1. Automatically refreshes configuration from both files periodically
2. Validates required settings before operations
3. Provides fallback values when settings are missing
4. Handles configuration changes without requiring service restarts

## Scripts

### Provisioning Azure Resources

The `provision_services.py` script creates all necessary Azure resources:

```bash
python provision_services.py
```

This script:
1. Loads configuration from `config.json`
2. Checks if each resource exists, creating it if necessary
3. Retrieves connection strings and keys
4. Generates a `local.settings.json` file with all necessary settings

### Deleting Azure Resources

The `delete_services.py` script safely removes Azure resources:

```bash
python delete_services.py
```

This script:
1. Loads configuration from `config.json`
2. Identifies active resources from `local.settings.json`
3. Deletes only the resources that were created by the provisioning script
4. Preserves the resource group

## Running the Application

### 1. Start the Producer Service

```bash
python Producer.py
```

This starts a Flask server on port 5001 that accepts image uploads and sends them to the Event Hub.

### 2. Start the Consumer Service

```bash
python Consumer.py
```

This starts a Flask server on port 5002 that listens for predictions from the Event Hub and makes them available to the web app.

### 3. Open the Web Interface

Open `index.html` in a web browser to interact with the application.

## Development Notes

- The Azure Function App is deployed with the code in `function_app.py`
- The web interface communicates with the Producer and Consumer services via HTTP
- Images are processed and sent to Azure ML for prediction
- Predictions are streamed back to the web interface in real-time

## Improvements

The recent improvements to the codebase include:

1. Centralized configuration management with `config.json`
2. Enhanced error handling and logging in both provisioning and deletion scripts
3. Consistent resource naming between provisioning and deletion
4. Better tracking of active resources for safe deletion
5. Improved API version selection for different resource types
6. Dynamic configuration loading with automatic refresh
7. Health check endpoints for all services
8. Improved resilience with connection validation and reconnection logic
9. Comprehensive management of related services (Application Insights, Log Analytics, Key Vault)
10. Intelligent resource identification for deletion based on naming patterns and resource types

## Related Services Management

The system now properly manages related Azure services:

1. **Provisioning**: The `provision_services.py` script now creates and tracks related services:
   - Application Insights for monitoring
   - Log Analytics workspace for logging
   - Key Vault for secrets management

2. **Deletion**: The `delete_services.py` script now intelligently identifies and deletes related services using:
   - Resource naming pattern matching
   - Resource type identification
   - Dependency-aware deletion ordering

This ensures that all components of the system, including supporting services, are properly managed throughout the application lifecycle.
